@model List<mvcblog.Models.CartItem>

<h2>GIỎ HÀNG</h2>

@if (Model.Count > 0)
{
    decimal total = 0;
    int stt = 1;

    <table class="table">
        <tr>
            <th>#</th>
            <th>Sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th></th>
        </tr>
        @foreach (var cartitem in Model)
        {
            var thanhtien = cartitem.quantity * cartitem.product.Price;
            total += thanhtien;

            <tr>
                <td>@(stt++)</td>
                <td>@cartitem.product.Name</td>
                <td>@(cartitem.product.Price.ToString("n0"))</td>
                <td><input asp-for="@cartitem.quantity" id="@($"quantity-{cartitem.product.ProductId}")" /></td>
                <td>@(thanhtien.ToString("n0"))</td>
                <td>
                    <button class="btn btn-success updatecartitem"
                            data-productid="@cartitem.product.ProductId">
                        Cập nhật
                    </button>
                    <a asp-route="removecart" asp-route-productid="@cartitem.product.ProductId"
                       class="btn btn-danger">Xóa</a>
                </td>
            </tr>
        }
        <tr>
            <td colspan="4" class="text-right">Tổng tiền</td>
            <td>@(total.ToString("n0"))</td>
            <td></td>
        </tr>
    </table>

    <a asp-controller="Product" asp-action="Checkout" class="btn btn-success">Gửi đơn hàng</a>

    @section Scripts {
    <script>
        $(document).ready(function () {
            $(".updatecartitem").click(function (event) {
                event.preventDefault();
                var productid = $(this).attr("data-productid");
                var quantity = $("#quantity-" + productid).val();
                $.ajax({
                    type: "POST",
                    url: "@Url.RouteUrl("updatecart")",
                    data: {
                        productid: productid,
                        quantity: quantity
                    },
                    success: function (result) {
                        window.location.href = "@Url.RouteUrl("cart")";
                    }
                });
            });
        });
    </script>
    }

}
else
{
    <p class="alert alert-danger">Giỏ hàng trống</p>
}

<div id="content" class="float_r">
    <h1>Shopping Cart</h1>
    <table width="680px" cellspacing="0" cellpadding="5">
        <tr bgcolor="#ddd">
            <th width="220" align="left">Image </th>
            <th width="180" align="left">Description </th>
            <th width="100" align="center">Quantity </th>
            <th width="60" align="right">Price </th>
            <th width="60" align="right">Total </th>
            <th width="90"> </th>
        </tr>
        <tr>
            <td><img src="images/product/01.jpg" alt="Image 01" /></td>
            <td>Etiam in tellus</td>
            <td align="center"><input type="text" value="1" style="width: 20px; text-align: right" /> </td>
            <td align="right">$100 </td>
            <td align="right">$100 </td>
            <td align="center"> <a href="#">Remove</a> </td>
        </tr>
        <tr>
            <td><img src="images/product/02.jpg" alt="Image 02" /> </td>
            <td>Hendrerit justo</td>
            <td align="center"><input type="text" value="1" style="width: 20px; text-align: right" />  </td>
            <td align="right">$40  </td>
            <td align="right">$40 </td>
            <td align="center"> <a href="#">Remove</a>  </td>
        </tr>
        <tr>
            <td colspan="3" align="right" height="30px">Have you modified your basket? Please click here to <a href="shoppingcart.html"><strong>Update</strong></a>&nbsp;&nbsp; <br /> Validate <a href="http://validator.w3.org/check?uri=referer" rel="nofollow"><strong>XHTML</strong></a> &amp; <a href="http://jigsaw.w3.org/css-validator/check/referer" rel="nofollow"><strong>CSS</strong></a>&nbsp;&nbsp; </td>
            <td align="right" style="background:#ddd; font-weight:bold"> Total </td>
            <td align="right" style="background:#ddd; font-weight:bold">$140 </td>
            <td style="background:#ddd; font-weight:bold"> </td>
        </tr>
    </table>
    <div style="float:right; width: 215px; margin-top: 20px;">

        <p><a href="checkout.html">Proceed to checkout</a></p>
        <p><a href="javascript:history.back()">Continue shopping</a></p>

    </div>













    @section Scripts {
        <script>
            $(document).ready(function () {
                $(".updatecartitem").click(function (event) {
                    event.preventDefault();

                    // Thu thập toàn bộ sản phẩm và số lượng trong giỏ hàng
                    var cartData = [];
                    $(".cart-item-row").each(function () {
                        var productid = $(this).data("productid");
                        var quantity = $("#quantity-" + productid).val();
                        cartData.push({ productid: productid, quantity: quantity });
                    });

                    // Gửi danh sách sản phẩm tới server
                    $.ajax({
                        type: "POST",
                        url: "@Url.RouteUrl("updatecart")",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(cartData), // Chuyển danh sách thành JSON
                        success: function () {
                            console.log("Cập nhật giỏ hàng thành công.");
                            window.location.href = "@Url.RouteUrl("cart")"; // Refresh giỏ hàng
                        },
                        error: function () {
                            alert("Có lỗi xảy ra khi cập nhật giỏ hàng.");
                        }
                    });
                });
            });
        </script>

    }
